<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Static Motion-Pic | Cinematic Video Generator</title>
    <!-- Tailwind CSS untuk Styling Cepat & Responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }

        .drop-zone {
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%23475569FF' stroke-width='2' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        .drop-zone.drag-over {
            background-color: rgba(59, 130, 246, 0.1);
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%233B82F6FF' stroke-width='3' stroke-dasharray='12%2c 12' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Loading Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Container -->
    <main class="w-full max-w-5xl glass-panel rounded-2xl shadow-2xl overflow-hidden p-6 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">
                Static Motion-Pic
            </h1>
            <p class="text-slate-400 text-sm md:text-base">
                Ubah gambar diam menjadi video sinematik (Ken Burns Effect) secara instan.
                <br>
                <span class="text-xs text-emerald-500 font-mono bg-emerald-900/30 px-2 py-1 rounded mt-2 inline-block">Zero Server Latency â€¢ Browser Native Rendering</span>
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Left Column: Input & Settings -->
            <div class="space-y-6">
                <!-- Drop Zone -->
                <div id="dropZone" class="drop-zone w-full h-48 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-800/50">
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                    <div class="text-center p-6 pointer-events-none">
                        <svg class="w-10 h-10 text-slate-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p class="text-base font-semibold text-slate-300">Drag & Drop Gambar</p>
                        <p class="text-xs text-slate-500 mt-1">atau klik untuk memilih dari komputer</p>
                    </div>
                </div>

                <!-- Separator -->
                <div class="flex items-center gap-4">
                    <div class="h-px bg-slate-700 flex-1"></div>
                    <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Atau via Link</span>
                    <div class="h-px bg-slate-700 flex-1"></div>
                </div>

                <!-- URL Input -->
                <div class="bg-slate-800/30 p-3 rounded-xl border border-slate-700/50">
                    <label class="block text-xs text-slate-400 mb-2 font-medium">Muat Gambar dari URL (Direct Link)</label>
                    <div class="flex gap-2">
                        <input type="url" id="urlInput" placeholder="https://contoh.com/gambar.jpg" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm focus:border-blue-500 focus:outline-none transition text-slate-200 placeholder-slate-600">
                        <button id="addUrlBtn" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition border border-slate-600">
                            Tambah
                        </button>
                    </div>
                    <p class="text-[10px] text-amber-500/80 mt-2 italic flex items-start gap-1">
                        <svg class="w-3 h-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Link harus mengarah langsung ke file gambar (bukan viewer Google Drive). Pastikan server gambar mengizinkan akses pihak ketiga (CORS Enabled).</span>
                    </p>
                </div>

                <!-- File List Preview -->
                <div id="fileListContainer" class="hidden">
                    <h3 class="text-sm font-semibold text-slate-400 mb-2">Antrean Gambar (<span id="fileCount">0</span>)</h3>
                    <div id="fileList" class="flex gap-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-slate-700">
                        <!-- Thumbnails will be injected here -->
                    </div>
                </div>

                <!-- Settings -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                    <h3 class="text-sm font-semibold text-blue-400 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Konfigurasi Render
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Durasi per Slide (detik)</label>
                            <input type="number" id="durationInput" value="4" min="2" max="10" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm focus:border-blue-500 focus:outline-none transition text-white">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Resolusi Output</label>
                            <select id="resolutionInput" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm focus:border-blue-500 focus:outline-none transition text-white">
                                <option value="1080">1080p (FHD)</option>
                                <option value="720">720p (HD)</option>
                                <option value="480">480p (SD)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <button id="generateBtn" disabled class="w-full py-4 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 flex justify-center items-center gap-2">
                    <span>Generate Cinematic Video</span>
                </button>

                <!-- Progress Bar -->
                <div id="progressContainer" class="hidden space-y-2">
                    <div class="flex justify-between text-xs text-slate-400">
                        <span id="statusText">Inisialisasi...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-2.5 overflow-hidden">
                        <div id="progressBar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Preview & Output -->
            <div class="flex flex-col space-y-4">
                <div class="relative w-full aspect-video bg-black rounded-xl overflow-hidden border border-slate-700 shadow-inner flex items-center justify-center group">
                    
                    <!-- Hidden Canvas for Processing -->
                    <canvas id="renderCanvas" class="hidden"></canvas>
                    
                    <!-- Video Player -->
                    <video id="outputVideo" class="w-full h-full object-contain hidden" controls></video>
                    
                    <!-- Empty State -->
                    <div id="previewPlaceholder" class="text-center">
                        <div class="animate-pulse text-slate-600">
                            <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            <span class="text-sm font-medium">Area Preview</span>
                        </div>
                    </div>
                </div>

                <!-- Download Area -->
                <div id="downloadArea" class="hidden p-4 bg-emerald-900/20 border border-emerald-500/30 rounded-xl flex justify-between items-center">
                    <div class="text-emerald-400 text-sm">
                        <span class="font-bold">Selesai!</span> Video siap diunduh.
                    </div>
                    <a id="downloadLink" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold rounded-lg transition shadow-lg flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download .webm
                    </a>
                </div>
                
                <!-- Debug/Info Console -->
                <div class="bg-black/40 p-3 rounded-lg border border-slate-800 h-32 overflow-y-auto text-xs font-mono text-slate-500" id="consoleLog">
                    <div>> System Ready. Menunggu input...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        /**
         * STATIC MOTION-PIC CORE LOGIC
         * Menggunakan Canvas API + MediaRecorder API
         */

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const urlInput = document.getElementById('urlInput');
        const addUrlBtn = document.getElementById('addUrlBtn');
        const generateBtn = document.getElementById('generateBtn');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileList = document.getElementById('fileList');
        const fileCountSpan = document.getElementById('fileCount');
        
        const canvas = document.getElementById('renderCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); 
        const outputVideo = document.getElementById('outputVideo');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const progressPercent = document.getElementById('progressPercent');
        const downloadArea = document.getElementById('downloadArea');
        const downloadLink = document.getElementById('downloadLink');
        const consoleLog = document.getElementById('consoleLog');

        let images = []; // Menyimpan objek ImageBitmap
        let isProcessing = false;

        // --- Utility Functions ---
        function log(msg) {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            div.innerHTML = `<span class="text-slate-600">[${time}]</span> ${msg}`;
            consoleLog.appendChild(div);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function updateUIState() {
            fileCountSpan.innerText = images.length;
            if (images.length > 0) {
                fileListContainer.classList.remove('hidden');
                generateBtn.disabled = false;
                generateBtn.innerText = 'Generate Cinematic Video';
            } else {
                generateBtn.disabled = true;
            }
        }

        function addThumbnail(url) {
            const imgDiv = document.createElement('div');
            imgDiv.className = 'flex-shrink-0 w-16 h-16 bg-cover bg-center rounded border border-slate-600 relative animate-fade-in';
            imgDiv.style.backgroundImage = `url(${url})`;
            fileList.appendChild(imgDiv);
        }

        // --- Drag & Drop & File Input Handlers ---
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        async function handleFiles(fileListInput) {
            if (fileListInput.length === 0) return;

            // Note: Drag & drop usually implies replacing the set in this simple app context,
            // but we can also treat it as append. For now, let's reset to keep it clean unless requested otherwise.
            // But since we added URL feature (append style), let's reset here to be safe for "New Project" feel via drop.
            images = [];
            fileList.innerHTML = '';
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="loader mr-2"></div> Memuat Gambar...';

            const validFiles = Array.from(fileListInput).filter(file => file.type.startsWith('image/'));
            
            if (validFiles.length === 0) {
                alert("Harap masukkan file gambar yang valid.");
                updateUIState();
                return;
            }

            log(`Menerima ${validFiles.length} file lokal.`);

            try {
                for (let i = 0; i < validFiles.length; i++) {
                    const file = validFiles[i];
                    
                    // Thumbnail
                    const reader = new FileReader();
                    reader.onload = (e) => addThumbnail(e.target.result);
                    reader.readAsDataURL(file);

                    // Bitmap
                    const bitmap = await createImageBitmap(file);
                    images.push(bitmap);
                }
                
                log("Semua gambar lokal dimuat.");
                updateUIState();

            } catch (err) {
                console.error(err);
                log("Error saat memuat gambar lokal: " + err.message);
                generateBtn.innerText = 'Error - Reset & Coba Lagi';
            }
        }

        // --- URL Input Handler ---
        addUrlBtn.addEventListener('click', async () => {
            const url = urlInput.value.trim();
            if (!url) return;

            const originalBtnText = addUrlBtn.innerText;
            addUrlBtn.innerHTML = '<div class="loader w-3 h-3 border-2"></div>'; // Tiny loader
            addUrlBtn.disabled = true;
            urlInput.disabled = true;

            log(`Mencoba mengunduh gambar dari URL...`);

            try {
                // Fetch sebagai blob
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error ${response.status}`);
                }
                
                const blob = await response.blob();
                
                if (!blob.type.startsWith('image/')) {
                    throw new Error('URL tidak mengarah ke file gambar yang valid (MIME type mismatch).');
                }

                // Create Bitmap
                const bitmap = await createImageBitmap(blob);
                images.push(bitmap);

                // Add Thumbnail (create Object URL from blob)
                const objectUrl = URL.createObjectURL(blob);
                addThumbnail(objectUrl);

                log("Berhasil memuat gambar dari URL.");
                urlInput.value = ''; // Clear input
                updateUIState();

            } catch (err) {
                console.error(err);
                const isCors = err.message.includes('Failed to fetch') || err.name === 'TypeError';
                let alertMsg = `Gagal memuat gambar: ${err.message}`;
                
                if (isCors) {
                    alertMsg = "Gagal mengakses gambar (CORS Error).\n\nKemungkinan penyebab:\n1. Server website tujuan memblokir akses langsung dari aplikasi luar.\n2. Link bukan direct link ke file gambar.\n\nSolusi: Gunakan gambar dari sumber yang mendukung CORS (seperti Unsplash, Pexels) atau upload file secara manual.";
                    log("Gagal: CORS Policy blocking.");
                } else {
                    log(`Gagal: ${err.message}`);
                }
                
                alert(alertMsg);
            } finally {
                addUrlBtn.innerText = originalBtnText;
                addUrlBtn.disabled = false;
                urlInput.disabled = false;
                urlInput.focus();
            }
        });

        // --- Core Rendering Logic ---

        generateBtn.addEventListener('click', async () => {
            if (isProcessing || images.length === 0) return;
            startProcessing();
        });

        async function startProcessing() {
            isProcessing = true;
            
            // UI Updates
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50');
            progressContainer.classList.remove('hidden');
            downloadArea.classList.add('hidden');
            outputVideo.classList.add('hidden');
            previewPlaceholder.classList.remove('hidden');

            // Config
            const fps = 30;
            const durationPerSlide = parseInt(document.getElementById('durationInput').value) || 4;
            const resolutionY = parseInt(document.getElementById('resolutionInput').value) || 1080;
            const resolutionX = (resolutionY / 9) * 16; // 16:9 Aspect Ratio
            
            // Setup Canvas
            canvas.width = resolutionX;
            canvas.height = resolutionY;
            log(`Canvas diset ke ${resolutionX}x${resolutionY} @ ${fps}fps`);

            // Setup MediaRecorder
            const stream = canvas.captureStream(fps);
            const mimeTypes = [
                'video/webm;codecs=vp9',
                'video/webm;codecs=vp8',
                'video/webm',
                'video/mp4'
            ];
            
            let selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || '';
            
            if (!selectedMimeType) {
                alert("Browser Anda tidak mendukung perekaman Canvas. Silakan gunakan Chrome/Firefox/Edge terbaru.");
                isProcessing = false;
                return;
            }

            log(`Menggunakan Codec: ${selectedMimeType}`);
            
            const mediaRecorder = new MediaRecorder(stream, {
                mimeType: selectedMimeType,
                videoBitsPerSecond: 5000000 // 5 Mbps
            });

            const chunks = [];
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                finalizeVideo(chunks, selectedMimeType);
            };

            mediaRecorder.start();

            // --- ANIMATION LOOP ---
            const totalFramesPerSlide = fps * durationPerSlide;
            const transitionFrames = fps * 1; // 1 detik transisi crossfade
            const totalSlides = images.length;
            
            const slideParams = images.map(img => calculateKenBurnsParams(img, resolutionX, resolutionY));

            async function renderLoop(frameCounter, globalFrame) {
                const slideDurationFrames = totalFramesPerSlide;
                const totalAnimationFrames = totalSlides * slideDurationFrames;

                if (globalFrame >= totalAnimationFrames) {
                    mediaRecorder.stop();
                    return;
                }

                // Calculate slide
                const slideIndex = Math.floor(globalFrame / slideDurationFrames);
                const localFrame = globalFrame % slideDurationFrames;
                const progress = localFrame / slideDurationFrames; 

                // Clear Canvas
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, resolutionX, resolutionY);

                // --- DRAW CURRENT SLIDE ---
                if (slideIndex < totalSlides) {
                    const img = images[slideIndex];
                    const params = slideParams[slideIndex];
                    
                    const currentScale = params.startScale + (params.endScale - params.startScale) * progress;
                    
                    const sx = params.sx_start + (params.sx_end - params.sx_start) * progress;
                    const sy = params.sy_start + (params.sy_end - params.sy_start) * progress;
                    const sw = params.sw_start + (params.sw_end - params.sw_start) * progress;
                    const sh = params.sh_start + (params.sh_end - params.sh_start) * progress;

                    ctx.drawImage(img, sx, sy, sw, sh, 0, 0, resolutionX, resolutionY);
                }

                // --- DRAW NEXT SLIDE (CROSSFADE) ---
                const framesUntilEnd = slideDurationFrames - localFrame;
                
                if (framesUntilEnd <= transitionFrames && slideIndex < totalSlides - 1) {
                    const nextSlideIndex = slideIndex + 1;
                    const nextImg = images[nextSlideIndex];
                    const nextParams = slideParams[nextSlideIndex];

                    const transitionProgress = 1 - (framesUntilEnd / transitionFrames);
                    
                    ctx.save();
                    ctx.globalAlpha = transitionProgress;

                    const nextProgress = transitionProgress * (transitionFrames / slideDurationFrames); 
                    
                    const n_sx = nextParams.sx_start + (nextParams.sx_end - nextParams.sx_start) * nextProgress;
                    const n_sy = nextParams.sy_start + (nextParams.sy_end - nextParams.sy_start) * nextProgress;
                    const n_sw = nextParams.sw_start + (nextParams.sw_end - nextParams.sw_start) * nextProgress;
                    const n_sh = nextParams.sh_start + (nextParams.sh_end - nextParams.sh_start) * nextProgress;

                    ctx.drawImage(nextImg, n_sx, n_sy, n_sw, n_sh, 0, 0, resolutionX, resolutionY);
                    
                    ctx.restore();
                }

                // Update Progress
                const percent = Math.round((globalFrame / totalAnimationFrames) * 100);
                progressBar.style.width = `${percent}%`;
                progressPercent.innerText = `${percent}%`;
                statusText.innerText = `Rendering Frame ${globalFrame}/${totalAnimationFrames}`;

                requestAnimationFrame(() => renderLoop(frameCounter + 1, globalFrame + 1));
            }

            log("Memulai proses rendering...");
            renderLoop(0, 0);
        }

        // --- Ken Burns Calculation Logic ---
        function calculateKenBurnsParams(img, canvasW, canvasH) {
            const imgRatio = img.width / img.height;
            const canvasRatio = canvasW / canvasH;
            
            // Base Crop Size
            let cropW, cropH;
            if (imgRatio > canvasRatio) {
                cropH = img.height;
                cropW = cropH * canvasRatio;
            } else {
                cropW = img.width;
                cropH = cropW / canvasRatio;
            }

            const zoomIntensity = 0.15 + (Math.random() * 0.10); 
            const isZoomIn = Math.random() > 0.5;

            const bigRect = { w: cropW, h: cropH };
            const smallRect = { w: cropW * (1 - zoomIntensity), h: cropH * (1 - zoomIntensity) };

            const anchorX = Math.random(); 
            const anchorY = Math.random();

            const maxOffsetX = img.width - cropW; 
            const maxOffsetY = img.height - cropH;

            const baseX = maxOffsetX / 2; 
            const baseY = maxOffsetY / 2;

            const bigRectX = baseX;
            const bigRectY = baseY;

            const diffW = bigRect.w - smallRect.w;
            const diffH = bigRect.h - smallRect.h;
            
            const smallRectX = bigRectX + (diffW * anchorX);
            const smallRectY = bigRectY + (diffH * anchorY);

            if (isZoomIn) {
                return {
                    sx_start: bigRectX, sy_start: bigRectY, sw_start: bigRect.w, sh_start: bigRect.h,
                    sx_end: smallRectX, sy_end: smallRectY, sw_end: smallRect.w, sh_end: smallRect.h,
                    startScale: 1.0, endScale: 1.0 + zoomIntensity
                };
            } else {
                return {
                    sx_start: smallRectX, sy_start: smallRectY, sw_start: smallRect.w, sh_start: smallRect.h,
                    sx_end: bigRectX, sy_end: bigRectY, sw_end: bigRect.w, sh_end: bigRect.h,
                    startScale: 1.0 + zoomIntensity, endScale: 1.0
                };
            }
        }

        // --- Finalize & Download ---
        function finalizeVideo(chunks, mimeType) {
            log("Rendering selesai. Menyusun file video...");
            const blob = new Blob(chunks, { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            outputVideo.src = url;
            outputVideo.classList.remove('hidden');
            previewPlaceholder.classList.add('hidden');
            
            downloadLink.href = url;
            
            const ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
            downloadLink.download = `static-motion-pic_${Date.now()}.${ext}`;
            
            downloadArea.classList.remove('hidden');
            progressContainer.classList.add('hidden');
            
            generateBtn.disabled = false;
            generateBtn.classList.remove('opacity-50');
            generateBtn.innerText = 'Generate Video Baru';
            
            isProcessing = false;
            log(`Video siap! Ukuran: ${(blob.size / 1024 / 1024).toFixed(2)} MB`);
        }

    </script>
</body>
</html>