<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Static Motion-Pic V2.1 | FFmpeg & Custom Fonts</title>
    
    <!-- Script Hack untuk SharedArrayBuffer (Wajib ada file coi-serviceworker.js di folder yang sama) -->
    <script src="coi-serviceworker.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FFmpeg.wasm -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/core@0.11.6/dist/ffmpeg-core.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-between p-4">

    <!-- Loading Overlay untuk FFmpeg -->
    <div id="ffmpegLoader" class="fixed inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center text-center">
        <div class="loader w-12 h-12 mb-4 border-t-emerald-500"></div>
        <h2 class="text-xl font-bold text-white">Memuat Core Video Engine...</h2>
        <p class="text-slate-400 text-sm mt-2 max-w-md">Mengunduh FFmpeg.wasm (~25MB).<br>Pastikan koneksi internet stabil.</p>
    </div>

    <!-- Main Container -->
    <main class="w-full max-w-6xl glass-panel rounded-2xl shadow-2xl overflow-hidden p-6 md:p-8 mb-8">
        
        <header class="text-center mb-8 border-b border-slate-700 pb-6">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2">
                Static Motion-Pic <span class="text-xs align-top bg-slate-700 text-white px-1 rounded">V2.1</span>
            </h1>
            <p class="text-slate-400 text-sm">
                Cinematic Video Generator dengan <span class="text-emerald-400 font-bold">Hard-Subtitles & Custom Fonts</span>.
            </p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Column: Inputs (5 Columns) -->
            <div class="lg:col-span-5 space-y-6 h-[75vh] overflow-y-auto pr-2 custom-scrollbar">
                
                <!-- 1. Image Manager -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-semibold text-blue-400">1. Aset Gambar</h3>
                        <button id="clearImagesBtn" class="text-xs text-red-400 hover:text-red-300 underline">Hapus Semua</button>
                    </div>
                    
                    <div id="dropZone" class="w-full h-32 border-2 border-dashed border-slate-600 hover:border-blue-500 rounded-xl flex flex-col items-center justify-center cursor-pointer transition bg-slate-900/50 mb-3">
                        <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                        <span class="text-xs text-slate-400">Klik / Drop Gambar di sini</span>
                    </div>

                    <div class="flex gap-2 mb-3">
                        <input type="url" id="urlInput" placeholder="https://..." class="flex-1 bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white">
                        <button id="addUrlBtn" class="bg-slate-700 px-3 py-1 rounded text-xs hover:bg-slate-600 text-white">Add Link</button>
                    </div>

                    <div id="fileList" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                        <span class="text-xs text-slate-600 w-full text-center py-2 italic" id="emptyMsg">Belum ada gambar</span>
                    </div>
                </div>

                <!-- 2. Audio & Timing -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <h3 class="text-sm font-semibold text-blue-400 mb-3">2. Audio & Durasi</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">File Audio (Opsional)</label>
                            <input type="file" id="audioInput" accept="audio/*" class="w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-700 file:text-white hover:file:bg-slate-600">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-slate-400 mb-1">Durasi Slide (dtk)</label>
                                <input type="number" id="slideDuration" value="4" min="2" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-sm text-white">
                            </div>
                            <div class="bg-slate-900 p-2 rounded border border-slate-700 flex flex-col justify-center">
                                <span class="text-[10px] text-slate-500 uppercase">Estimasi Total</span>
                                <span id="totalDurationDisplay" class="text-emerald-400 font-mono text-sm">00:00</span>
                            </div>
                        </div>
                        <p id="audioWarning" class="text-[10px] text-amber-500 hidden italic"></p>
                    </div>
                </div>

                <!-- 3. Subtitles & Fonts -->
                <div class="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                    <h3 class="text-sm font-semibold text-blue-400 mb-3">3. Subtitle (Hard-Sub)</h3>
                    
                    <div class="space-y-4">
                        <!-- Input SRT -->
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">File Subtitle (.srt)</label>
                            <input type="file" id="srtInput" accept=".srt" class="w-full text-xs text-slate-400 file:mr-4 file:py-1 file:px-3 file:rounded file:border-0 file:bg-slate-700 file:text-white">
                        </div>
                        
                        <!-- Font Selection Logic -->
                        <div class="border-t border-slate-700 pt-3">
                            <label class="block text-xs text-emerald-400 font-bold mb-2">Pengaturan Font</label>
                            
                            <!-- Dropdown Pilihan Font -->
                            <div class="mb-2">
                                <label class="block text-[10px] text-slate-500 mb-1">Pilih Font Tersedia:</label>
                                <select id="fontSelect" class="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1 text-xs text-white">
                                    <!-- Opsi akan diisi oleh JavaScript -->
                                </select>
                            </div>

                            <!-- Upload Font Manual -->
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">Atau Upload Font Sendiri (.ttf):</label>
                                <input type="file" id="fontInput" accept=".ttf" class="w-full text-xs text-slate-400 file:mr-4 file:py-1 file:px-3 file:rounded file:border-0 file:bg-slate-700 file:text-white">
                            </div>
                        </div>
                    </div>
                </div>

                <button id="generateBtn" disabled class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 disabled:opacity-50 disabled:cursor-not-allowed transition flex justify-center items-center gap-2">
                    GENERATE VIDEO
                </button>
            </div>

            <!-- Right Column: Preview & Output -->
            <div class="lg:col-span-7 flex flex-col space-y-4">
                <div class="relative w-full aspect-video bg-black rounded-xl overflow-hidden border border-slate-700 shadow-inner flex items-center justify-center">
                    <canvas id="renderCanvas" class="hidden"></canvas>
                    <video id="outputVideo" class="w-full h-full object-contain hidden" controls></video>
                    
                    <div id="previewPlaceholder" class="text-center">
                        <div class="animate-pulse text-slate-600">
                            <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            <span class="text-sm font-medium">Area Preview Video</span>
                        </div>
                    </div>

                    <div id="processingOverlay" class="absolute inset-0 bg-black/80 z-20 hidden flex-col items-center justify-center p-8 text-center">
                        <div class="loader w-10 h-10 mb-4"></div>
                        <h3 class="text-lg font-bold text-white mb-1" id="processStatus">Merender Frame...</h3>
                        <p class="text-xs text-slate-400 mb-4" id="processDetail">Mohon tunggu, ini memerlukan CPU tinggi.</p>
                        <div class="w-full bg-slate-800 rounded-full h-2 overflow-hidden max-w-sm">
                            <div id="progressBar" class="bg-emerald-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-xs text-emerald-400 mt-2 font-mono">0%</p>
                    </div>
                </div>

                <div class="flex-1 bg-black/20 rounded-xl border border-slate-800 p-4 flex flex-col">
                    <div id="downloadArea" class="hidden flex justify-between items-center mb-4 bg-emerald-900/20 p-3 rounded-lg border border-emerald-500/30">
                        <span class="text-emerald-400 text-sm font-bold">Rendering Selesai!</span>
                        <a id="downloadLink" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs px-4 py-2 rounded font-bold shadow transition">Download MP4</a>
                    </div>
                    <div class="text-[10px] text-slate-500 font-mono uppercase mb-1">System Log</div>
                    <div id="consoleLog" class="flex-1 overflow-y-auto h-24 font-mono text-xs text-slate-400 bg-black/40 p-2 rounded border border-slate-800/50">
                        <div>> Menunggu inisialisasi FFmpeg...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer Credit -->
    <footer class="text-center text-slate-500 text-xs py-4">
        <p>Static Motion-Pic &copy; 2024. Dibuat dengan cinta dan kode.</p>
        <p class="mt-1">
            <span class="opacity-70">Credits Font:</span> 
            <!-- Ganti bagian ini sesuai lisensi font yang Anda pakai -->
            <a href="#" class="hover:text-emerald-400 transition">Roboto by Google</a> â€¢ 
            <a href="#" class="hover:text-emerald-400 transition">Bebas Neue by Ryoichi Tsunekawa</a>
        </p>
    </footer>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        
        /* * =================================================================
         * [AREA KONFIGURASI FONT PROYEK]
         * Di sini tempat Anda mendaftarkan font lokal yang ada di komputer/server Anda.
         * =================================================================
         */
        
        // Bentuk Wadah Font: Array of Objects
        const availableFonts = [
            // Opsi 1: Font Sistem (Bawaan Browser)
            { 
                name: "Default (Inter/System)", 
                type: "system", 
                value: "Inter, sans-serif" 
            },
            { 
                name: "Classic Serif", 
                type: "system", 
                value: "Times New Roman, serif" 
            },
            { 
                name: "Coding Monospace", 
                type: "system", 
                value: "Courier New, monospace" 
            },
            
            // Opsi 2: Font Lokal (File dalam proyek Anda)
            // UNCOMMENT bagian di bawah ini jika Anda sudah menaruh file .ttf di folder proyek
            /*
            {
                name: "Bebas Neue (Bold)", 
                type: "file",
                url: "fonts/BebasNeue-Regular.ttf", // Pastikan path ini benar!
                fontFamily: "BebasNeue" // Nama internal untuk CSS/Canvas
            },
            {
                name: "Lobster (Cursive)", 
                type: "file",
                url: "assets/fonts/Lobster-Regular.ttf",
                fontFamily: "Lobster"
            }
            */
        ];

        let activeFont = availableFonts[0].value; // Default font saat ini
        let ffmpeg = null;
        let images = []; 
        let audioFile = null;
        let subtitleData = [];
        let isProcessing = false;

        // --- DOM Elements ---
        const logEl = document.getElementById('consoleLog');
        const fileList = document.getElementById('fileList');
        const emptyMsg = document.getElementById('emptyMsg');
        const totalDurationEl = document.getElementById('totalDurationDisplay');
        const audioWarningEl = document.getElementById('audioWarning');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const fontSelect = document.getElementById('fontSelect');

        // --- INIT FONT SELECTOR ---
        function initFontSelector() {
            fontSelect.innerHTML = '';
            availableFonts.forEach((font, index) => {
                const option = document.createElement('option');
                option.value = index; // Kita simpan index array sebagai value
                option.text = font.name;
                fontSelect.appendChild(option);
            });
        }
        initFontSelector();

        // Listener saat user mengubah dropdown font
        fontSelect.addEventListener('change', async (e) => {
            const index = e.target.value;
            const selected = availableFonts[index];

            if (selected.type === 'system') {
                activeFont = selected.value;
                log(`Font diubah ke: ${selected.name}`);
            } else if (selected.type === 'file') {
                // Logic memuat font lokal dari URL (folder proyek)
                try {
                    log(`Memuat font: ${selected.name}...`);
                    const fontFace = new FontFace(selected.fontFamily, `url(${selected.url})`);
                    await fontFace.load();
                    document.fonts.add(fontFace);
                    activeFont = selected.fontFamily;
                    log(`Font berhasil dimuat: ${selected.name}`);
                } catch (err) {
                    console.error(err);
                    log(`Gagal memuat font ${selected.name}. Cek path file!`);
                    // Fallback ke default
                    activeFont = "Inter, sans-serif";
                }
            }
        });

        // Listener untuk upload font manual (.ttf)
        document.getElementById('fontInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const fontName = 'UploadedFont_' + Date.now();
                    const fontFace = new FontFace(fontName, arrayBuffer);
                    await fontFace.load();
                    document.fonts.add(fontFace);
                    
                    // Tambahkan ke dropdown dan pilih otomatis
                    const newOption = document.createElement('option');
                    newOption.text = `[Uploaded] ${file.name}`;
                    newOption.value = 'uploaded_manual';
                    fontSelect.appendChild(newOption);
                    fontSelect.value = 'uploaded_manual';
                    
                    activeFont = fontName;
                    log(`Font custom diupload: ${file.name}`);
                } catch (err) {
                    log("File font rusak atau tidak didukung.");
                }
            }
        });

        // --- Init FFmpeg ---
        async function loadFFmpeg() {
            try {
                ffmpeg = createFFmpeg({ log: false }); 
                await ffmpeg.load();
                document.getElementById('ffmpegLoader').classList.add('hidden');
                log("FFmpeg Core dimuat. Sistem siap.");
            } catch (e) {
                console.error(e);
                document.getElementById('ffmpegLoader').innerHTML = `
                    <div class="text-red-500 font-bold">Gagal memuat FFmpeg!</div>
                    <p class="text-xs text-white mt-2">Pastikan browser mendukung SharedArrayBuffer (coi-serviceworker).</p>
                `;
            }
        }
        loadFFmpeg();

        // --- Logger ---
        function log(msg) {
            const div = document.createElement('div');
            div.innerHTML = `<span class="text-slate-600">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // --- Image Management ---
        function addImage(bitmap, thumbUrl) {
            images.push({ bitmap, thumbUrl });
            renderFileList();
            updateDurationEstimate();
            checkReady();
        }

        function renderFileList() {
            fileList.innerHTML = '';
            if (images.length === 0) {
                fileList.appendChild(emptyMsg);
                return;
            }
            images.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = 'w-14 h-14 bg-cover bg-center rounded border border-slate-600 relative group';
                div.style.backgroundImage = `url(${img.thumbUrl})`;
                div.innerHTML = `<span class="absolute bottom-0 right-0 bg-black/70 text-white text-[9px] px-1">${idx+1}</span>`;
                fileList.appendChild(div);
            });
        }

        document.getElementById('clearImagesBtn').addEventListener('click', () => {
            images = [];
            renderFileList();
            updateDurationEstimate();
            checkReady();
            log("Semua gambar dihapus.");
        });

        document.getElementById('dropZone').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                const bitmap = await createImageBitmap(file);
                const thumbUrl = URL.createObjectURL(file);
                addImage(bitmap, thumbUrl);
            }
            log(`Menambahkan ${files.length} gambar.`);
            e.target.value = ''; 
        });

        document.getElementById('addUrlBtn').addEventListener('click', async () => {
            const url = document.getElementById('urlInput').value;
            if(!url) return;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Gagal fetch URL");
                const blob = await res.blob();
                const bitmap = await createImageBitmap(blob);
                const thumbUrl = URL.createObjectURL(blob);
                addImage(bitmap, thumbUrl);
                document.getElementById('urlInput').value = '';
                log("Gambar dari URL ditambahkan.");
            } catch(e) {
                alert("Gagal memuat gambar dari URL (CORS error?).");
            }
        });

        // --- Audio Handler ---
        document.getElementById('audioInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                audioFile = file;
                const audioObj = new Audio(URL.createObjectURL(file));
                audioObj.onloadedmetadata = () => {
                    audioFile.duration = audioObj.duration;
                    updateDurationEstimate();
                    log(`Audio dimuat: ${file.name} (${audioObj.duration.toFixed(1)}s)`);
                };
            } else {
                audioFile = null;
                updateDurationEstimate();
            }
        });

        // --- Subtitle Parser ---
        function parseSRT(text) {
            // PERBAIKAN: Menggunakan new RegExp() dengan string escaping untuk menghindari error parser pada regex literal
            const pattern = new RegExp("(\\d+)\\n(\\d{2}:\\d{2}:\\d{2},\\d{3}) --> (\\d{2}:\\d{2}:\\d{2},\\d{3})\\n([\\s\\S]*?)(?=\\n\\n|\\n*$)", "g");
            
            const result = [];
            let match;
            while ((match = pattern.exec(text)) !== null) {
                result.push({
                    start: timeToSeconds(match[2]),
                    end: timeToSeconds(match[3]),
                    text: match[4].trim()
                });
            }
            return result;
        }

        function timeToSeconds(timeString) {
            const [h, m, s] = timeString.split(':');
            const [sec, ms] = s.split(',');
            return parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(sec) + parseInt(ms) / 1000;
        }

        document.getElementById('srtInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    subtitleData = parseSRT(evt.target.result);
                    log(`Subtitle dimuat: ${subtitleData.length} baris.`);
                };
                reader.readAsText(file);
            } else {
                subtitleData = [];
            }
        });

        // --- Duration Calculation Logic ---
        function updateDurationEstimate() {
            const slideDur = parseInt(document.getElementById('slideDuration').value) || 4;
            const imgCount = images.length;
            let totalSec = imgCount * slideDur;
            let warning = "";

            if (audioFile && audioFile.duration) {
                const audioSec = audioFile.duration;
                if (totalSec > audioSec) {
                    totalSec = audioSec + 5; 
                    warning = "Video > Audio: Durasi dipotong menjadi Audio + 5 detik.";
                } else if (totalSec < audioSec) {
                    totalSec = audioSec; 
                    warning = "Video < Audio: Layar hitam akan ditambahkan di akhir.";
                }
            }

            const min = Math.floor(totalSec / 60).toString().padStart(2, '0');
            const sec = Math.floor(totalSec % 60).toString().padStart(2, '0');
            totalDurationEl.innerText = `${min}:${sec}`;

            if (warning) {
                audioWarningEl.innerText = warning;
                audioWarningEl.classList.remove('hidden');
            } else {
                audioWarningEl.classList.add('hidden');
            }
            return totalSec;
        }

        document.getElementById('slideDuration').addEventListener('input', updateDurationEstimate);

        function checkReady() {
            const btn = document.getElementById('generateBtn');
            btn.disabled = images.length === 0 || !ffmpeg;
        }

        // --- CORE GENERATION PROCESS ---
        document.getElementById('generateBtn').addEventListener('click', async () => {
            if (!ffmpeg || images.length === 0) return;
            
            isProcessing = true;
            document.getElementById('processingOverlay').classList.remove('hidden');
            document.getElementById('downloadArea').classList.add('hidden');
            
            // Config
            const fps = 24; 
            const slideDur = parseInt(document.getElementById('slideDuration').value) || 4;
            const targetWidth = 1280; 
            const targetHeight = 720;
            
            const canvas = document.getElementById('renderCanvas');
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            const ctx = canvas.getContext('2d');

            // 1. Determine Logic Durasi
            let totalVideoFrames = (images.length * slideDur) * fps;
            let finalFrames = totalVideoFrames;
            let mode = 'normal'; 

            if (audioFile && audioFile.duration) {
                const audioFrames = Math.ceil(audioFile.duration * fps);
                const bufferFrames = 5 * fps; 

                if (totalVideoFrames > audioFrames) {
                    finalFrames = audioFrames + bufferFrames;
                    mode = 'cut';
                    log(`Mode CUT: Membatasi video di frame ${finalFrames}.`);
                } else if (totalVideoFrames < audioFrames) {
                    finalFrames = audioFrames;
                    mode = 'extend';
                    log(`Mode EXTEND: Video diperpanjang hingga frame ${finalFrames}.`);
                }
            }

            // 2. Render Frames Loop
            log("Mulai merender frame ke memori...");
            
            try { ffmpeg.FS('unlink', 'output.mp4'); } catch(e){}
            try { ffmpeg.FS('unlink', 'audio.mp3'); } catch(e){}

            const framesPerSlide = slideDur * fps;
            const transitionFrames = fps * 1; 

            const slideParams = images.map(img => calculateKenBurnsParams(img.bitmap, targetWidth, targetHeight));

            for (let i = 0; i < finalFrames; i++) {
                const pct = Math.round((i / finalFrames) * 50); 
                progressBar.style.width = `${pct}%`;
                progressText.innerText = `Rendering Image ${i}/${finalFrames}`;
                
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, targetWidth, targetHeight);

                if (i < totalVideoFrames) {
                    const slideIndex = Math.floor(i / framesPerSlide);
                    const localFrame = i % framesPerSlide;
                    const progress = localFrame / framesPerSlide;

                    if (slideIndex < images.length) {
                        drawKenBurns(ctx, images[slideIndex].bitmap, slideParams[slideIndex], progress, targetWidth, targetHeight);
                    }

                    const framesUntilEnd = framesPerSlide - localFrame;
                    if (framesUntilEnd <= transitionFrames && slideIndex < images.length - 1) {
                        const nextIndex = slideIndex + 1;
                        const transProgress = 1 - (framesUntilEnd / transitionFrames);
                        
                        ctx.save();
                        ctx.globalAlpha = transProgress;
                        const nextProgress = transProgress * (transitionFrames / framesPerSlide);
                        drawKenBurns(ctx, images[nextIndex].bitmap, slideParams[nextIndex], nextProgress, targetWidth, targetHeight);
                        ctx.restore();
                    }
                }

                // 3. Draw Subtitles (Menggunakan Font Pilihan)
                const currentTime = i / fps;
                const activeSub = subtitleData.find(s => currentTime >= s.start && currentTime <= s.end);
                
                if (activeSub) {
                    ctx.save();
                    // Gunakan variabel activeFont yang diatur oleh dropdown
                    ctx.font = `bold 32px ${activeFont}`; 
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillStyle = 'white';
                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 4;
                    ctx.lineJoin = "round";
                    
                    const lines = getLines(ctx, activeSub.text, targetWidth - 100);
                    const lineHeight = 40;
                    const bottomY = targetHeight - 50;

                    lines.reverse().forEach((line, idx) => {
                        const y = bottomY - (idx * lineHeight);
                        ctx.strokeText(line, targetWidth / 2, y);
                        ctx.fillText(line, targetWidth / 2, y);
                    });
                    ctx.restore();
                }

                const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
                const arrayBuffer = await blob.arrayBuffer();
                const fileName = `img_${i.toString().padStart(5, '0')}.jpg`;
                ffmpeg.FS('writeFile', fileName, new Uint8Array(arrayBuffer));
                
                if (i % 50 === 0) await new Promise(r => setTimeout(r, 0)); 
            }

            // 3. Audio Handling
            let audioCmdInput = [];
            
            if (audioFile) {
                document.getElementById('processStatus').innerText = "Memproses Audio...";
                const audioData = await fetchFile(audioFile);
                ffmpeg.FS('writeFile', 'audio.mp3', audioData);
                audioCmdInput = ['-i', 'audio.mp3'];
            }

            // 4. Run FFmpeg Command
            document.getElementById('processStatus').innerText = "Encoding Video (MP4)...";
            document.getElementById('processDetail').innerText = "Menyatukan ribuan gambar menjadi video.";
            progressBar.style.width = '75%';
            progressText.innerText = "Encoding...";

            log("Menjalankan perintah FFmpeg...");
            
            const argsSequence = [
                '-framerate', fps.toString(),
                '-i', 'img_%05d.jpg',
                ...audioCmdInput,
                '-c:v', 'libx264',
                '-pix_fmt', 'yuv420p',
                '-preset', 'ultrafast',
                'output.mp4'
            ];

            await ffmpeg.run(...argsSequence);

            // 5. Retrieve & Cleanup
            progressBar.style.width = '100%';
            progressText.innerText = "Selesai!";
            
            const data = ffmpeg.FS('readFile', 'output.mp4');
            
            log("Membersihkan memori...");
            for (let i = 0; i < finalFrames; i++) {
                try {
                    ffmpeg.FS('unlink', `img_${i.toString().padStart(5, '0')}.jpg`);
                } catch(e){}
            }

            const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
            const videoUrl = URL.createObjectURL(videoBlob);
            
            const outputVideo = document.getElementById('outputVideo');
            outputVideo.src = videoUrl;
            outputVideo.classList.remove('hidden');
            document.getElementById('previewPlaceholder').classList.add('hidden');
            document.getElementById('processingOverlay').classList.add('hidden');

            const dlLink = document.getElementById('downloadLink');
            dlLink.href = videoUrl;
            dlLink.download = `static-motion-v2_${Date.now()}.mp4`;
            document.getElementById('downloadArea').classList.remove('hidden');

            log("Render selesai. Video siap.");
            isProcessing = false;
        });

        // --- Helper: Draw Ken Burns ---
        function drawKenBurns(ctx, img, params, progress, cw, ch) {
            const scale = params.startScale + (params.endScale - params.startScale) * progress;
            const sx = params.sx_start + (params.sx_end - params.sx_start) * progress;
            const sy = params.sy_start + (params.sy_end - params.sy_start) * progress;
            const sw = params.sw_start + (params.sw_end - params.sw_start) * progress;
            const sh = params.sh_start + (params.sh_end - params.sh_start) * progress;
            ctx.drawImage(img, sx, sy, sw, sh, 0, 0, cw, ch);
        }

        function calculateKenBurnsParams(img, canvasW, canvasH) {
            const imgRatio = img.width / img.height;
            const canvasRatio = canvasW / canvasH;
            let cropW, cropH;

            if (imgRatio > canvasRatio) {
                cropH = img.height;
                cropW = cropH * canvasRatio;
            } else {
                cropW = img.width;
                cropH = cropW / canvasRatio;
            }

            const zoomIntensity = 0.15; 
            const bigRect = { w: cropW, h: cropH };
            const smallRect = { w: cropW * (1 - zoomIntensity), h: cropH * (1 - zoomIntensity) };
            
            const anchorX = Math.random(); 
            const anchorY = Math.random();
            
            const maxOffsetX = img.width - cropW;
            const maxOffsetY = img.height - cropH;
            const baseX = maxOffsetX / 2;
            const baseY = maxOffsetY / 2;

            const bigRectX = baseX;
            const bigRectY = baseY;

            const diffW = bigRect.w - smallRect.w;
            const diffH = bigRect.h - smallRect.h;
            const smallRectX = bigRectX + (diffW * anchorX);
            const smallRectY = bigRectY + (diffH * anchorY);

            const isZoomIn = Math.random() > 0.5;

            if (isZoomIn) {
                return {
                    sx_start: bigRectX, sy_start: bigRectY, sw_start: bigRect.w, sh_start: bigRect.h,
                    sx_end: smallRectX, sy_end: smallRectY, sw_end: smallRect.w, sh_end: smallRect.h,
                    startScale: 1.0, endScale: 1.0 + zoomIntensity
                };
            } else {
                return {
                    sx_start: smallRectX, sy_start: smallRectY, sw_start: smallRect.w, sh_start: smallRect.h,
                    sx_end: bigRectX, sy_end: bigRectY, sw_end: bigRect.w, sh_end: bigRect.h,
                    startScale: 1.0 + zoomIntensity, endScale: 1.0
                };
            }
        }

        function getLines(ctx, text, maxWidth) {
            var words = text.split(" ");
            var lines = [];
            var currentLine = words[0];

            for (var i = 1; i < words.length; i++) {
                var word = words[i];
                var width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }
    </script>
</body>
</html>